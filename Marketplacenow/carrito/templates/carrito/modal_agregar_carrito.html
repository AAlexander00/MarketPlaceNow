<div id="modal-carrito" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-xl relative">
        <!-- BotÃ³n de cierre -->
        <button id="cerrar-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>

        <h2 class="text-xl font-bold mb-4">Selecciona las opciones</h2>

        <form id="form-modal-carrito" method="POST">
            {% csrf_token %}
            <input type="hidden" name="producto_id" id="modal-producto-id">

            <!-- Tallas -->
            <div id="grupo-talla" class="mb-4 hidden">
                <label for="modal-talla" class="block font-semibold mb-1">Talla:</label>
                <select name="talla" id="modal-talla" class="w-full border rounded px-3 py-2"></select>
            </div>

            <!-- Colores -->
            <div id="grupo-color" class="mb-4 hidden">
                <label for="modal-color" class="block font-semibold mb-1">Color:</label>
                <select name="color" id="modal-color" class="w-full border rounded px-3 py-2"></select>
            </div>

            <!-- Cantidad -->
            <div class="mb-4">
                <label for="modal-cantidad" class="block font-semibold mb-1">Cantidad:</label>
                <input type="number" name="cantidad" id="modal-cantidad" min="1" value="1" class="w-full border rounded px-3 py-2">
            </div>

            <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">
                Agregar al carrito
            </button>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('modal-carrito');
    const cerrarBtn = document.getElementById('cerrar-modal');
    cerrarBtn.addEventListener('click', () => modal.classList.add('hidden'));

    function manejarAgregarProducto(productoId, tieneTallas, tieneColores) {
        document.getElementById('modal-producto-id').value = productoId;
        const grupoTalla = document.getElementById('grupo-talla');
        const grupoColor = document.getElementById('grupo-color');
        grupoTalla.classList.toggle('hidden', !tieneTallas);
        grupoColor.classList.toggle('hidden', !tieneColores);

        if (tieneTallas) {
            fetch(`/productos/${productoId}/tallas/`)
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('modal-talla');
                    select.innerHTML = '';
                    data.tallas.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = t.valor;
                        select.appendChild(option);
                    });
                });
        }

        if (tieneColores) {
            fetch(`/productos/${productoId}/colores/`)
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('modal-color');
                    select.innerHTML = '';
                    data.colores.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.nombre;
                        select.appendChild(option);
                    });
                });
        }

        modal.classList.remove('hidden');
    }

    document.getElementById('form-modal-carrito').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const productoId = formData.get('producto_id');

        fetch(`/carrito/agregar/${productoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                modal.classList.add('hidden');
                const contador = document.getElementById("carrito-count");
                if (contador) {
                    contador.textContent = data.total_items;
                    contador.classList.add("contador-animado");
                    setTimeout(() => contador.classList.remove("contador-animado"), 300);
                }
            }
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>